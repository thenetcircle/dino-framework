<html>
    <head>
        <script type="text/javascript" src="js/jquery-3.5.1.min.js"></script>
        <script type="text/javascript" src="js/mqtt.min.js"></script>
        <script type="text/javascript">
            let socket;
            let groups = {};
            const user_id = '33';
            const endpoint = 'http://localhost:9800/v1';

            function add_group_link(group_id, group_name) {
                $("div#groups").append(
                    `<a href='#' class='join-group' id='${group_id}'>${group_name}</a><br />`
                );
            }

            function format_message(created_at_float, message_id, message_payload, sender_id) {
                let created_at = format_date(new Date(created_at_float * 1000));
                return `${created_at} - ${sender_id} - ${message_payload}\n`
            }

            function get_history(group_id, until, should_clear) {
                $.ajax({
                    type: 'POST',
                    url: `${endpoint}/groups/${group_id}/user/${user_id}/histories`,
                    contentType: 'application/json',
                    dataType: 'json',
                    processData: false,
                    data: JSON.stringify({
                        per_page: 10,
                        until: until
                    }),
                    success: function(resp){
                        console.log(resp);

                        let history = $("pre#history");
                        let until = $("input#until");

                        if (should_clear) {
                            history.html("");
                        }

                        for (let i = 0; i < resp["messages"].length; i++) {
                            let msg = resp["messages"][i];

                            history.append(
                                format_message(
                                    msg.created_at,
                                    msg.message_id,
                                    msg.message_payload,
                                    msg.user_id
                                )
                            );
                            until.val(msg.created_at);
                        }
                    }
                });
            }

            function get_group_name(group_id) {
                $.ajax({
                    type: 'GET',
                    url: `${endpoint}/groups/${group_id}`,
                    contentType: 'application/json',
                    dataType: 'json',
                    processData: false,
                    success: function(resp) {
                        groups[group_id] = resp.name;
                        add_group_link(group_id, resp.name);
                    }
                });
            }

            function format_date(d) {
                return d.getFullYear() + "-" +
                    ("0" + (d.getMonth() + 1)).slice(-2) + "-" +
                    ("0" + d.getDate()).slice(-2) + " " +
                    ("0" + d.getHours()).slice(-2) + ":" +
                    ("0" + d.getMinutes()).slice(-2) + ":" +
                    ("0" + d.getSeconds()).slice(-2);
            }

            function reset_file_id() {
                let file_id = parseInt((Math.random() * 1000000).toString());
                $("input#file_id").val(file_id);
                $("input#get_file_id").val(file_id);
            }

            $(document).ready(function() {
                let settings = {
                    clientId: user_id,
                    username: user_id,
                    clean: false,
                    qos: 1
                }
                let client  = mqtt.connect('mqtt://maggie-kafka-1.thenetcircle.lab:1880/mqtt', settings);

                client.on('connect', function () {
                    client.subscribe(user_id, {qos: 1}, function (err) {
                        if (err) {
                            console.log(err);
                        }
                    })
                });

                function is_message_event(json_data) {
                    return json_data.event_type === "message";
                }

                function is_for_this_group(json_data) {
                    return $("input#current_group").val() === json_data.group_id;
                }

                function is_new_group(json_data) {
                    return !(json_data.group_id in groups);
                }

                client.on('message', function (topic, message) {
                    let json_data = JSON.parse(message.toString())

                    // add a pretty-printed version to the event log
                    $('#events').append(JSON.stringify(json_data, null, 2) + "\n");

                    if (is_message_event(json_data) && is_for_this_group(json_data)) {
                        let history = $("pre#history");

                        history.prepend(
                            format_message(
                                json_data.created_at,
                                json_data.message_id,
                                json_data.message_payload,
                                json_data.sender_id
                            )
                        );

                        if (is_new_group(json_data)) {
                            get_group_name(json_data.group_id);
                        }
                    }
                });

                // get all current groups
                $.ajax({
                    type: 'POST',
                    url: `${endpoint}/users/${user_id}/groups`,
                    contentType: 'application/json',
                    dataType: 'json',
                    processData: false,
                    data: JSON.stringify({
                        per_page: 100
                    }),
                    success: function(resp) {
                        for (let i = 0; i < resp.length; i++) {
                            let group_id = resp[i]["group"].group_id;
                            let group_name = resp[i]["group"].name;

                            groups[group_id] = resp.name;
                            add_group_link(group_id, group_name);
                        }
                    }
                });

                $(document).on('click', 'a#next', function() {
                    let group_id = $("input#current_group").val();
                    let until = parseFloat($("input#until").val());

                    get_history(group_id, until, false);
                });

                $(document).on('click', 'a.join-group', function() {
                    let group_id = $(this).attr('id');
                    let now = new Date();
                    let until = Math.round(now.getTime() / 1000);

                    $("input#current_group").val(group_id);
                    get_history(group_id, until, true);
                });

                $("input#send-msg").click(function() {
                    let sender = $("input#sender").val();
                    let receiver = parseInt($("input#receiver").val());
                    let message_type = parseInt($("input#message_type").val());
                    let message_payload = $("textarea#message_payload").val();

                    $.ajax({
                        type: 'POST',
                        url: `${endpoint}/users/${sender}/send`,
                        contentType: 'application/json',
                        dataType: 'json',
                        processData: false,
                        data: JSON.stringify({
                            receiver_id: receiver,
                            message_type: message_type,
                            message_payload: message_payload
                        }),
                        success: function(resp){
                            console.log(resp);

                            $("input#message_id").val(resp["message_id"]);
                            $("input#created_at").val(resp["created_at"]);
                            $("input#group_id").val(resp["group_id"]);
                            reset_file_id();
                        }
                    });
                });

                $("input#update-attachment").click(function() {
                    let sender = $("input#sender").val();
                    let message_id = $("input#message_id").val();
                    let file_id = $("input#file_id").val();
                    let receiver = parseInt($("input#receiver").val());
                    let created_at = parseFloat($("input#created_at").val());
                    let message_type = parseInt($("input#message_type").val());

                    let json_data = JSON.stringify({
                        receiver_id: receiver,
                        file_id: file_id,
                        created_at: created_at,
                        message_type: message_type,
                        message_payload: "{\"width\":\"400\",\"height\":\"240\"}",
                    });
                    console.log(json_data)

                    $.ajax({
                        type: 'POST',
                        url: `${endpoint}/users/${sender}/message/${message_id}/attachment`,
                        contentType: 'application/json',
                        dataType: 'json',
                        processData: false,
                        data: json_data,
                        success: function(resp){
                            console.log(resp);

                            $("input#message_id").val(resp["message_id"]);
                            $("input#created_at").val(resp["created_at"]);
                        }
                    })
                });

                $("input#get-attachment").click(function() {
                    let file_id = $("input#get_file_id").val();
                    let group_id = $("input#group_id").val();

                    let json_data = JSON.stringify({
                        group_id: group_id,
                        file_id: file_id,
                    });
                    console.log(json_data)

                    $.ajax({
                        type: 'POST',
                        url: `${endpoint}/groups/${group_id}/attachment`,
                        contentType: 'application/json',
                        dataType: 'json',
                        data: json_data,
                        success: function(data) {
                            console.log(data);
                            $("pre#attachment").html(JSON.stringify(data, null, 2));
                        }
                    })
                });
            });
        </script>
    </head>
    <body>
        <h1>REST/MQTT test</h1>

        <table style="width: 100%;" border="1">
            <tr>
                <td style="width: 50%;">
                    <pre id="events" style="height: 350px; overflow-y: scroll;"></pre>
                </td>
                <td style="vertical-align: top;">
                    <div id="rest">
                        <label for="sender">
                            sender:
                            <input type="text" id="sender" value="33"/>
                        </label><br />

                        <label for="receiver">
                            receiver:
                            <input type="text" id="receiver" value="66" />
                        </label><br />

                        <label for="message_type">
                            message type:
                            <input type="text" id="message_type" value="0" />
                        </label><br />

                        <label for="message_payload">
                            <textarea id="message_payload">some text here</textarea>
                        </label><br />

                        <input type="button" id="send-msg" value="send message">
                        <br /><br />

                        <label for="message_id">
                            message ID:
                            <input type="text" id="message_id" value="" />
                        </label><br />

                        <label for="file_id">
                            file ID:
                            <input type="text" id="file_id" value="" />
                        </label><br />

                        <label for="created_at">
                            created at:
                            <input type="text" id="created_at" value="" />
                        </label><br />

                        <input type="button" id="update-attachment" value="update attachment">
                        <br /><br />

                        <label for="get_file_id">
                            file ID:
                            <input type="text" id="get_file_id" value="" />
                        </label><br />

                        <label for="group_id">
                            group ID:
                            <input type="text" id="group_id" value="" />
                        </label><br />

                        <input type="button" id="get-attachment" value="get attachment info">
                        <br /><br />
                    </div>
                    <br />

                    <div style="width: 500px; overflow-wrap: break-word;">
                        attachment:
                        <pre style="border: 1px solid black;" id="attachment"></pre>
                    </div>
                </td>
            </tr>
            <tr>
                <td style="vertical-align: top;">
                    <span><a href="#" id="next">next page</a></span>
                    <pre id="history" style="height: 350px; overflow-y: scroll;"></pre>
                </td>
                <td style="vertical-align: top;">
                    <span>groups</span>

                    <label for="until">
                        <input id="until" style="display: none;" />
                    </label>
                    <label for="current_group">
                        <input id="current_group" style="display: none;" />
                    </label>
                    <div id="groups"></div>
                </td>
            </tr>
        </table>
    </body>
</html>
